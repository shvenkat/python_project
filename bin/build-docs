#!/bin/bash

# Load common settings, global variables and functions.
if [[ -z "${BASH_UTILS_DEFINED:-""}" ]]; then
    # shellcheck source=bash-utils
    source "$(dirname "$0")/bash-utils"
fi


# -- CONSTANTS --

# Sphinx directory, relative to the repo root. This directory must have the following contents
# generated by sphinx-quickstart:
#     Makefile
#     source/conf.py
#     source/index.rst.
declare -r SPHINX_DIR="docs/sphinx"


# -- FUNCTIONS --

# Print a help message, without exiting.
# Args: None.
usage () {
    echo "Usage: $NAME [options]" 1>&2
    echo "    Builds the project HTML docs from docstrings in the source using Sphinx." 1>&2
    echo 1>&2
    echo "Options:" 1>&2
    echo "    --no-open         Don't open the built docs in your default browser." 1>&2
    echo "    --verbose         Show more detailed messages." 1>&2
    echo "    -h|--help|help    Show this message." 1>&2
}

# Parses arguments, runs sphinx and opens the docs in a browser.
# Args:
#   $@: Program arguments.
function main {
    # Parse arguments.
    local do_open="true"
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --no-open)
                do_open="false"
                shift
                ;;
            --verbose)
                export DEBUG="true"
                shift
                ;;
            --help|-h|help)
                usage
                exit 0
                ;;
            *)
                usage
                exit 1
                ;;
        esac
    done

    # Change directory to the project root and update the python environment.
    initialize

    # Run sphinx to build HTML documentation.
    log debug "Building HTML documentation."
    run_func run_sphinx

    if [[ "$do_open" == "true" ]]; then
        log debug "Opening HTML documentation in your default browser."
        run_func open_docs
    fi
}

# Runs sphinx to build the HTML documentation from docstrings in the source.
# Args: None.
function run_sphinx {
    # Check that sphinx is installed.
    if ! which sphinx-build >/dev/null 2>&1; then
        log error "sphinx-build not found. Add sphinx to the Pipfile."
        exit 1
    fi
    cd "${SPHINX_DIR}"

    # Generate the doc skeleton by finding all python modules in the repo root, except setup.py.
    log debug "Finding Python modules to document and creating doc skeleton in $SPHINX_DIR/source."
    find source -maxdepth 1 -type f -name '*.rst' ! -name 'index.rst' -delete
    sphinx-apidoc --force --separate --module-first -o source "$REPO_DIR" "$REPO_DIR/setup.py" \
        >/dev/null

    # Call sphinx-build to generate HTML output using the Makefile created by sphinx-quickstart.
    log debug "Generating HTML output in $SPHINX_DIR/build/html."
    run_exec make html >/dev/null

    cd - >/dev/null 2>&1
}

# Opens the built HTML documentation in the default browser. Currently only supports MacOS.
# Args: None.
function open_docs {
    index_html="$REPO_DIR/$SPHINX_DIR/build/html/index.html"
    if which open &>/dev/null; then
        open "$index_html"
    else
        log warning "'open' not found. Please browse to file://${index_html}."
    fi
}


# -- MAIN --

main "$@"
